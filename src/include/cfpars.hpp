/* cfpars.hpp
 * 
 * A class encapsulating crystal field parameters and their conversions
 *
 * (C) 2018 Duc Le - duc.le@stfc.ac.uk
 * This program is licensed under the GNU General Purpose License, version 3. Please see the LICENSE file
 */

#ifndef CFPARS_H
#define CFPARS_H

#include<array>
#include<algorithm>
#include<cctype>
#include<cmath>
#include<complex>
#include<stdexcept>
#include<string>
#include<unordered_map>
#include<limits>

#include "racah.hpp"
#include "eigen.hpp"

namespace libMcPhase {

// Conversion factors for different energy units[from][to], order: [meV, cm, K].
static const std::array<double, 3> ENERGYCONV = { {1., 8.065544005, 11.6045221} };

// Conversion factors from Stevens to Wybourn normalisation
static const std::array<double, 27> lambda = {
    {sqrt(6.)/2., sqrt(6.), 1./2., sqrt(6.), sqrt(6.)/2., // l=2
     sqrt(70.)/8., sqrt(35.)/2., sqrt(10.)/4., sqrt(5.)/2., 1./8., sqrt(5.)/2., sqrt(10.)/4., sqrt(35.)/2., sqrt(70.)/8., // l=4
     sqrt(231.)/16., 3*sqrt(77.)/8., 3*sqrt(14.)/16., sqrt(105.)/8., sqrt(105.)/16., sqrt(42.)/8., // l=6, m=-6 to m=-1
     1./16., sqrt(42.)/8., sqrt(105.)/16., sqrt(105.)/8., 3*sqrt(14.)/16., 3*sqrt(77.)/8., sqrt(231.)/16.} };

// Normalisation factors for Fabi parameters, defined as sqrt( sum_{Jz, Jz'} |<Jz|Olm|Jz'>|^2 / (2J+1) )
static const std::array< std::array<double, 27>, 17> FABINORM = {{
/* J=0 */   {0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.},
/* J=1/2 */ {0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.},
/* J=1 */   {-0.8164965809, -0.4082482905, 1.4142135624, 0.4082482905, 0.8164965809, 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.},
/* J=3/2 */ {-1.7320508076, -0.8660254038, 3., 0.8660254038, 1.7320508076, 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.},
/* J=2 */   {-2.8982753492, -1.4491376746, 5.0199601592, 1.4491376746, 2.8982753492, -7.5894663844, -2.683281573, -10.0399203184, -7.0992957397, 44.8998886413,
             7.0992957397, 10.0399203184, 2.683281573, 7.5894663844, 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.},
/* J=5/2 */ {-4.3204937989, -2.1602468995, 7.4833147735, 2.1602468995, 4.3204937989, -21.9089023002, -7.7459666924, -28.9827534924, -20.4939015319, 129.6148139682,
             20.4939015319, 28.9827534924, 7.7459666924, 21.9089023002, 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.},
/* J=3 */   {-6., -3., 10.3923048454, 3., 6., -47.5694980303, -16.8183573174, -62.9285308902, -44.4971909226, 281.4249455894, 44.4971909226, 62.9285308902,
             16.8183573174, 47.5694980303, -192.4280941769, -55.5492059864, -260.5488712041, -142.708494091, -285.416988182, -225.6419413901, 2068.0425527537,
             225.6419413901, 285.416988182, 142.708494091, 260.5488712041, 55.5492059864, 192.4280941769},
/* J=7/2 */ {-7.9372539332, -3.9686269666, 13.7477270849, 3.9686269666, 7.9372539332, -88.9943818451, -31.4642654451, -117.7285012221, -83.2466215531,
             526.4978632435, 83.2466215531, 117.7285012221, 31.4642654451, 88.9943818451, -673.4983296193, -194.4222209522, -911.9210492142, -499.4797293184,
             -998.9594586368, -789.7467948653, 7238.1489346379, 789.7467948653, 998.9594586368, 499.4797293184, 911.9210492142, 194.4222209522, 673.4983296193},
/* J=4 */   {-10.1324561024, -5.0662280512, 17.5499287748, 5.0662280512, 10.1324561024, -151.2613632095, -53.4789678285, -200.0999750125, -141.4920492466,
             894.8742928479, 141.4920492466, 200.0999750125, 53.4789678285, 151.2613632095, -1738.9652095427, -501.9960159204, -2354.5700244418, -1289.6511156123,
             -2579.3022312246, -2039.117456156, 18688.8201874811, 2039.117456156, 2579.3022312246, 1289.6511156123, 2354.5700244418, 501.9960159204, 1738.9652095427},
/* J=9/2 */ {-12.585706178, -6.292853089, 21.7990825495, 6.292853089, 12.585706178, -240.119970015, -84.895229548, -317.64886274, -224.6116648796, 1420.5689001242,
             224.6116648796, 317.64886274, 84.895229548, 240.119970015, -3809.881887933, -1099.8181667894, -5158.6044624491, -2825.4840293302, -5650.9680586604,
             -4467.4825125567, 40945.1535593652, 4467.4825125567, 5650.9680586604, 2825.4840293302, 5158.6044624491, 1099.8181667894, 3809.881887933,},
/* J=5 */   {-15.2970585408, -7.6485292704, 26.495282599, 7.6485292704, 15.2970585408, -361.994475096, -127.9843740462, -478.8736785416, -338.6148254285,
             2141.588195709, 338.6148254285, 478.8736785416, 127.9843740462, 361.994475096, -7488.7552066718, -2161.8174172336, -10139.8224836533, -5553.8095033949,
             -11107.6190067899, -8781.3438607083, 80482.3458902634, 8781.3438607083, 11107.6190067899, 5553.8095033949, 10139.8224836533, 2161.8174172336, 7488.7552066718},
/* J=11/2 */{-18.2665450118, -9.1332725059, 31.6385840391, 9.1332725059, 18.2665450118, -523.984732602, -185.2565788306, -693.1666466298, -490.1428363243, 3099.9354831996,
             490.1428363243, 693.1666466298, 185.2565788306, 523.984732602, -13603.9994119377, -3927.1363612689, -18419.9022798711, -10088.9959857262, -20177.9919714525,
             -15952.1033095953, 146203.4418199517, 15952.1033095953, 20177.9919714525, 10088.9959857262, 18419.9022798711, 3927.1363612689, 13603.9994119377},
/* J=6 */   {-21.4941852602, -10.7470926301, 37.229020938, 10.7470926301, 21.4941852602, -733.8664728682, -259.4609797253, -970.8140913687, -686.4692272783,
             4341.6126036301, 686.4692272783, 970.8140913687, 259.4609797253, 733.8664728682, -23258.7690659144, -6714.2282906125, -31492.5221893413, -17249.1647958342,
             -34498.3295916684, -27273.3242452147, 249964.1456135413, 27273.3242452147, 34498.3295916684, 17249.1647958342, 31492.5221893413, 6714.2282906125, 23258.7690659144},
/* J=13/2 */{-24.9799919936, -12.4899959968, 43.2666153056, 12.4899959968, 24.9799919936, -1000.0914243922, -353.5857139971, -1322.9965986351, -935.4998663816, 5916.6206570981,
             935.4998663816, 1322.9965986351, 353.5857139971, 1000.0914243922, -37884.3955814452, -10936.2829935168, -51295.7141066804, -28095.8197195648, -56191.6394391296,
             -44423.391521649, 407147.1085492319, 44423.391521649, 56191.6394391296, 28095.8197195648, 51295.7141066804, 10936.2829935168, 37884.3955814452},
/* J=7 */   {-28.723973727, -14.3619868635, 49.7513818904, 14.3619868635, 28.723973727, -1331.7873704162, -470.8579403599, -1761.7890906689, -1245.7730130325,
             7878.9603375065, 1245.7730130325, 1761.7890906689, 470.8579403599, 1331.7873704162, -59298.458664623, -17117.990536275, -80290.4925878525, -43976.9139435682,
             -87953.8278871363, -69533.6062634465, 637286.0280909977, 69533.6062634465, 87953.8278871363, 43976.9139435682, 80290.4925878525, 17117.990536275, 59298.458664623},
/* J=15/2 */{-32.7261363439, -16.363068172, 56.6833308831, 16.363068172, 32.7261363439, -1738.7581775509, -614.7438490949, -2300.1608639397, -1626.4593447117, 10286.6321019078,
             1626.4593447117, 2300.1608639397, 614.7438490949, 1738.7581775509, -89767.4996866906, -25913.6450542952, -121545.7691571368, -66573.3595366795, -133146.7190733591,
             -105261.7238125996, 964739.6343055468, 105261.7238125996, 133146.7190733591, 66573.3595366795, 121545.7691571368, 25913.6450542952, 89767.4996866906},
/* J=8 */   {-36.9864840178, -18.4932420089, 64.0624695122, 18.4932420089, 36.9864840178, -2231.4838112789, -788.9486675317, -2951.9756096553, -2087.3619714846,
             13201.6362622214, 2087.3619714846, 2951.9756096553, 788.9486675317, 2231.4838112789, -132074.3790445369, -38126.589147208, -178829.5546043774, -97948.9810054194,
             -195897.9620108387, -154870.9372348473, 1419415.585654885, 154870.9372348473, 195897.9620108387, 97948.9810054194, 178829.5546043774, 38126.589147208, 132074.3790445369},
}};

// Point symmetry tables - classes are triclinic, monoclinic, etc. to cubic
static const std::array<int, 10> SYM_CLASS = {{ 1, 2, 4, 8, 16, 32, 64, 128, 256, 512 }};
static const std::array<int, 27> BLM_SYM = {{ 3, 1, 511, 1, 7, 11, 33, 3, 1, 1023, 1, 7, 97, 543, 163, 1, 11, 33, 3, 1, 1023, 1, 7, 97, 543, 1, 999 }}; 


class cfpars {

    public:
    enum class Units {meV = 0, cm = 1, K = 2};
    enum class Normalisation {Stevens, Wybourne};
    enum class Type {Alm, Blm, Llm, ARlm, Nlm};
    enum class Blm {B22S = 0, B21S = 1, B20 = 2, B21 = 3, B22 = 4,
                    B44S = 5, B43S = 6, B42S = 7, B41S = 8, B40 = 9, B41 = 10, B42 = 11, B43 = 12, B44 = 13,
                    B66S = 14, B65S = 15, B64S = 16, B63S = 17, B62S = 18, B61S = 19, 
                    B60 = 20, B61 = 21, B62 = 22, B63 = 23, B64 = 24, B65 = 25, B66 = 26};
    enum class Sym {Ci=0, C1=1, C2=10, Cs=11, C2h=12, C2v=20, D2=21, D2h=22, C4=30, S4=31, C4h=32,
                    D4=40, C4v=41, D2d=42, D4h=43, C3=50, S6=51, D3=60, C3v=61, D3d=62, C6=71, C3h=72, C6h=73,
                    D6=80, C6v=81, D3h=82, D6h=83, T=90, Th=91, Td=92, O=93, Oh=94};

    protected:
        std::array<double, 27> m_Bi{};                        // Internal array of values (in Wybourne/theta_k in meV)
        std::array<double, 27> m_Bo{};                        // Output array of parameters.
        std::array<double, 3> m_rk{};                         // Radial integrals <r^k> (if constructed from ionname)
        std::array<double, 3> m_stevfact = {{1., 1., 1.}};    // Stevens factors \theta_k
        std::array<double, 27> m_convfact;                    // Conversion factor from internal to external parameters
        double m_econv = 1.;                                  // Conversion factor from internal to external energy
        Units m_unit = Units::meV;                            // Energy units of parameters
        Normalisation m_norm = Normalisation::Stevens;        // Normalisation (Stevens or Wybourne)
        Type m_type = Type::Blm;                              // Type of crystal field parameters
        std::string m_ionname;                                // Name of ion
        int m_J2 = 0;                                         // 2*J == twice the total angular momentum
        double m_GJ = -1.;                                    // Lande g-factor
        bool m_convertible = false;                           // True if can convert between types and normalisations
        racah m_racah{};                                      // Class to calc n-j symbols and cache factorials
        int m_n = 1;                                          // Number of open shell electrons in this configuration
        Sym m_sym = Sym::C1;                                  // Point symmetry of site
        
    public:
        // Methods
        virtual void getfromionname(const std::string &ionname);
        bool is_sym_allowed(const Blm blm);
        std::vector<Blm> get_sym_allowed_Blm();
        // Getters
        Units get_unit() const { return m_unit; }
        Normalisation get_normalisation() const { return m_norm; }
        Type get_type() const { return m_type; }
        std::string get_name() const { return m_ionname; }
        double get(const Blm blm) const { return m_Bo[(int)blm]; }
        double get(int l, int m) const;
        double get_GJ() const { return m_GJ; }
        double alpha() const { return m_stevfact[0]; }
        double beta() const { return m_stevfact[1]; }
        double gamma() const { return m_stevfact[2]; }
        double get_J() const { return (double)(m_J2 / 2.); }
        Sym get_sym() const { return m_sym; }
        // Setters
        virtual void set_unit(const Units newunit);
        virtual void set_type(const Type newtype);
        virtual void set_name(const std::string &ionname);
        virtual void set_J(const double J);
        virtual void set_GJ(const double GJ) { m_GJ = GJ; }
        virtual void set(const Blm blm, double val);
        virtual void set(int l, int m, double val);
        void set_sym(const Sym newsym) { m_sym = newsym; }
        // Constructors
        cfpars();
        cfpars(const int J2);
        cfpars(const double J);
        cfpars(const std::string &ionname);
    
}; // class cfpars

} // namespace libMcPhase

#endif
